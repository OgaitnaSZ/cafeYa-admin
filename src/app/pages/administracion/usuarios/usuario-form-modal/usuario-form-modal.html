<div
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
  (click)="onBackdropClick($event)"
>
  <div
    class="bg-white rounded-3xl shadow-2xl w-full max-w-md animate-slide-up"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="border-b border-gray-100 px-6 py-4 flex items-center justify-between">
      <div>
        <h3 class="text-xl font-black text-gray-900">{{ modalTitle() }}</h3>
        <p class="text-sm text-gray-500">Configurá los datos del usuario</p>
      </div>
      <button
        (click)="onClose()"
        class="w-9 h-9 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition cursor-pointer"
      >
        <lucide-angular [img]="X" class="w-5 h-5"></lucide-angular>
      </button>
    </div>

    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-6 space-y-5">
      
      <!-- Nombre -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Nombre completo <span class="text-red-500">*</span>
        </label>
        <input
          formControlName="nombre"
          type="text"
          placeholder="Ej: Juan Pérez"
          maxlength="100"
          class="
            w-full h-11 px-4 text-sm
            border-2 border-gray-200 rounded-xl
            focus:border-orange-500 focus:outline-none
            transition
          "
          [class.border-red-300]="form.get('nombre')?.invalid && form.get('nombre')?.touched"
        />
        @if(form.get('nombre')?.invalid && form.get('nombre')?.touched) {
          <p class="text-xs text-red-600 mt-1.5 ml-1">
            El nombre debe tener al menos 3 caracteres
          </p>
        }
      </div>

      <!-- Email -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Email <span class="text-red-500">*</span>
        </label>
        <input
          formControlName="email"
          type="email"
          placeholder="usuario@cafeya.com"
          class="
            w-full h-11 px-4 text-sm
            border-2 border-gray-200 rounded-xl
            focus:border-orange-500 focus:outline-none
            transition
          "
          [class.border-red-300]="form.get('email')?.invalid && form.get('email')?.touched"
        />
        @if(form.get('email')?.invalid && form.get('email')?.touched) {
          <p class="text-xs text-red-600 mt-1.5 ml-1">
            Ingresá un email válido
          </p>
        }
      </div>

      <!-- Contraseña -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Contraseña 
          @if(isEditMode()) {
            <span class="text-xs text-gray-500 font-normal">(dejá vacío para no cambiar)</span>
          } @else {
            <span class="text-red-500">*</span>
          }
        </label>
        <div class="relative">
          <input
            formControlName="password"
            [type]="showPassword() ? 'text' : 'password'"
            placeholder="••••••••"
            class="
              w-full h-11 px-4 pr-10 text-sm
              border-2 border-gray-200 rounded-xl
              focus:border-orange-500 focus:outline-none
              transition
            "
            [class.border-red-300]="form.get('password')?.invalid && form.get('password')?.touched"
          />
          <button
            type="button"
            (click)="togglePasswordVisibility()"
            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 cursor-pointer"
          >
            @if(showPassword()) {
              <lucide-icon [img]="EyeOff" class="w-5 h-5"/>
            } @else {
              <lucide-icon [img]="Eye" class="w-5 h-5"/>
            }
          </button>
        </div>
        @if(form.get('password')?.invalid && form.get('password')?.touched) {
          <p class="text-xs text-red-600 mt-1.5 ml-1">
            La contraseña debe tener al menos 6 caracteres
          </p>
        }
      </div>

      <!-- Rol -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-3">
          Rol <span class="text-red-500">*</span>
        </label>
        <div class="space-y-2">
          @for(rol of roles; track rol.value) {
            <label class="flex items-center gap-3 p-3 border-2 rounded-xl cursor-pointer transition hover:bg-gray-50"
              [class.border-orange-500]="form.get('rol')?.value === rol.value"
              [class.bg-orange-50]="form.get('rol')?.value === rol.value"
              [class.border-gray-200]="form.get('rol')?.value !== rol.value"
            >
              <input
                type="radio"
                formControlName="rol"
                [value]="rol.value"
                class="sr-only peer"
              />
              <div 
                class="w-10 h-10 rounded-xl flex items-center justify-center"
                [class.bg-red-100]="rol.color === 'red'"
                [class.bg-blue-100]="rol.color === 'blue'"
                [class.bg-orange-100]="rol.color === 'orange'"
              >
                <lucide-angular 
                  [img]="rol.icon" 
                  class="w-5 h-5"
                  [class.text-red-600]="rol.color === 'red'"
                  [class.text-blue-600]="rol.color === 'blue'"
                  [class.text-orange-600]="rol.color === 'orange'"
                ></lucide-angular>
              </div>
              <div class="flex-1">
                <p class="text-sm font-bold text-gray-900">{{ rol.label }}</p>
                <p class="text-xs text-gray-500">
                  @if(rol.value === 'admin') {
                    Acceso total al sistema
                  } @else if(rol.value === 'encargado') {
                    Gestión operativa y mesas
                  } @else {
                    Solo pedidos activos
                  }
                </p>
              </div>
              <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center"
                [class.border-orange-500]="form.get('rol')?.value === rol.value"
                [class.border-gray-300]="form.get('rol')?.value !== rol.value"
              >
                @if(form.get('rol')?.value === rol.value) {
                  <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                }
              </div>
            </label>
          }
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-3 pt-2">
        <button
          type="button"
          (click)="onClose()"
          [disabled]="saving()"
          class="
            flex-1 h-11
            border-2 border-gray-200 text-gray-700 font-semibold rounded-xl
            hover:bg-gray-50 disabled:opacity-50
            active:scale-95 transition-all
            cursor-pointer
          "
        >
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="form.invalid || saving()"
          class="
            flex-1 h-11
            bg-linear-to-r from-orange-500 to-red-500
            text-white font-bold rounded-xl
            shadow-lg shadow-orange-500/20
            disabled:opacity-50 disabled:cursor-not-allowed
            active:scale-95 transition-all
            flex items-center justify-center gap-2
            cursor-pointer
          "
        >
          @if(saving()) {
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            <span>Guardando...</span>
          } @else {
            <span>{{ isEditMode() ? 'Guardar Cambios' : 'Crear Usuario' }}</span>
          }
        </button>
      </div>
    </form>
  </div>
</div>