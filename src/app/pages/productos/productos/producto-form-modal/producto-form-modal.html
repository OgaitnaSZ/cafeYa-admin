<!-- Backdrop -->
<div
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
  (click)="onBackdropClick($event)"
>
  <!-- Modal -->
  <div
    class="
      bg-white rounded-3xl shadow-2xl
      w-full max-w-2xl
      max-h-[90vh] overflow-y-auto
      animate-slide-up
    "
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 flex items-center justify-between z-10">
      <div>
        <!-- Título dinámico -->
        <h3 class="text-xl font-black text-gray-900">{{ modalTitle() }}</h3>
        <p class="text-sm text-gray-500">{{ modalSubtitle() }}</p>
      </div>
      <button
        (click)="onClose()"
        class="
          w-9 h-9
          flex items-center justify-center
          rounded-lg
          text-gray-400 hover:text-gray-600 hover:bg-gray-100
          transition cursor-pointer
        "
      >
        
        <lucide-icon [img]="X" class="w-5 h-5"/>
      </button>
    </div>

    <!-- Form -->
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="p-6 space-y-5">
      
      <!-- Sección de imagen -->
      <div>
        <p class="text-sm font-semibold text-gray-700 mb-3">
          Imagen del producto
          @if(!isEditMode()) {
            <span class="text-xs text-gray-500 font-normal ml-1">(opcional)</span>
          }
        </p>

        <!-- Input file oculto -->
        <input
          id="fileInput"
          type="file"
          accept="image/*"
          (change)="onFileSelected($event)"
          class="hidden"
        />

        <div class="flex items-start gap-4">
          <!-- Preview o uploader -->
          <div class="relative group">
            @if(imagePreview()) {
              <!-- Imagen actual/preview -->
              <div class="
                w-32 h-32 rounded-xl overflow-hidden
                bg-gray-100 border-2 border-gray-200
                relative
              ">
                <img
                  [src]="imagePreview()!"
                  alt="Preview"
                  class="w-full h-full object-cover"
                />
                
                <!-- Overlay hover -->
                <div class="
                  absolute inset-0
                  bg-black/40
                  opacity-0 group-hover:opacity-100
                  transition-opacity
                  flex items-center justify-center
                ">
                  <button
                    type="button"
                    (click)="triggerFileInput()"
                    class="
                      px-3 py-1.5
                      bg-white text-gray-700
                      text-xs font-semibold
                      rounded-lg
                      hover:bg-gray-100
                      transition cursor-pointer
                    "
                  >
                    Cambiar
                  </button>
                </div>
              </div>
            } @else {
              <!-- Área de upload -->
              <button
                type="button"
                (click)="triggerFileInput()"
                class="
                  w-32 h-32 rounded-xl
                  border-2 border-dashed border-gray-300
                  bg-gray-50
                  hover:bg-gray-100 hover:border-orange-400
                  active:scale-95
                  transition-all
                  flex flex-col items-center justify-center gap-2
                  cursor-pointer
                "
              >
                <lucide-icon [img]="Image" class="w-8 h-8 text-gray-400"/>
                <span class="text-xs text-gray-500 font-medium">
                  Subir imagen
                </span>
              </button>
            }
          </div>

          <!-- Info de ayuda -->
          <div class="flex-1">
            <p class="text-xs text-gray-600 leading-relaxed">
              <span class="font-semibold">Recomendaciones:</span><br/>
              • Formato: JPG, PNG o WebP<br/>
              • Tamaño máximo: 5MB<br/>
              • Dimensiones: 800x800px<br/>
              • Fondo claro o transparente
            </p>
            @if(!isEditMode()) {
              <p class="text-xs text-amber-600 mt-2">
                ⚠️ Sin imagen el producto quedará inactivo
              </p>
            }
          </div>
        </div>
      </div>

      <!-- Nombre -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Nombre <span class="text-red-500">*</span>
        </label>
        <input
          formControlName="nombre"
          type="text"
          placeholder="Ej: Cappuccino"
          class="
            w-full h-11 px-4
            text-sm
            border-2 border-gray-200
            rounded-xl
            focus:border-orange-500 focus:outline-none
            transition
          "
          [class.border-red-300]="form.get('nombre')?.invalid && form.get('nombre')?.touched"
        />
      </div>

      <!-- Descripción -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          Descripción <span class="text-red-500">*</span>
        </label>
        <textarea
          formControlName="descripcion"
          rows="3"
          placeholder="Describe el producto..."
          class="
            w-full px-4 py-3
            text-sm
            border-2 border-gray-200
            rounded-xl
            focus:border-orange-500 focus:outline-none
            transition
            resize-none
          "
          [class.border-red-300]="form.get('descripcion')?.invalid && form.get('descripcion')?.touched"
        ></textarea>
      </div>

      <!-- Grid: Categoría, Precio y Stock -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <!-- Categoría -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Categoría <span class="text-red-500">*</span>
          </label>
          <select
            formControlName="categoria_id"
            class="
              w-full h-11 px-4
              text-sm
              border-2 border-gray-200
              rounded-xl
              focus:border-orange-500 focus:outline-none
              transition
            "
          >
            @for(cat of categorias; track cat.categoria_id) {
              <option [ngValue]="cat.categoria_id">{{ cat.nombre }}</option>
            }
          </select>
        </div>

        <!-- Precio -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Precio <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-500 text-sm font-semibold">
              $
            </span>
            <input
              formControlName="precio_unitario"
              type="number"
              min="0"
              step="100"
              placeholder="0"
              class="
                w-full h-11 pl-8 pr-4
                text-sm
                border-2 border-gray-200
                rounded-xl
                focus:border-orange-500 focus:outline-none
                transition
              "
              [class.border-red-300]="form.get('precio_unitario')?.invalid && form.get('precio_unitario')?.touched"
            />
          </div>
        </div>

        <!-- Stock -->
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Stock <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <input
              formControlName="stock"
              type="number"
              min="0"
              placeholder="0"
              class="
                w-full h-11 px-4
                text-sm
                border-2 border-gray-200
                rounded-xl
                focus:border-orange-500 focus:outline-none
                transition
              "
              [class.border-red-300]="form.get('stock')?.invalid && form.get('stock')?.touched"
              [class.border-red-500]="form.get('stock')?.value === 0"
              [class.bg-red-50]="form.get('stock')?.value === 0"
            />
            <!-- Indicador visual de stock -->
            <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
              @if(form.get('stock')?.value > 10) {
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
              } @else if(form.get('stock')?.value > 0) {
                <div class="w-2 h-2 rounded-full bg-yellow-500"></div>
              } @else {
                <div class="w-2 h-2 rounded-full bg-red-500"></div>
              }
            </div>
          </div>
          @if(form.get('stock')?.value === 0) {
            <p class="text-xs text-red-600 mt-1.5 ml-1">
              ⚠️ Sin stock el producto no estará disponible
            </p>
          } @else if(form.get('stock')?.value > 0 && form.get('stock')?.value <= 5) {
            <p class="text-xs text-yellow-600 mt-1.5 ml-1">
              ⚠️ Stock crítico
            </p>
          }
        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-3 pt-2">
        <button
          type="button"
          (click)="onClose()"
          class="
            flex-1 h-11
            border-2 border-gray-200
            text-gray-700 font-semibold
            rounded-xl
            hover:bg-gray-50
            active:scale-95
            transition-all cursor-pointer
          "
        >
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="form.invalid || saving()"
          class="
            flex-1 h-11
            bg-linear-to-r from-orange-500 to-red-500
            text-white font-bold
            rounded-xl
            shadow-lg shadow-orange-500/20
            disabled:opacity-50 disabled:cursor-not-allowed
            active:scale-95
            transition-all cursor-pointer
            flex items-center justify-center gap-2
          "
        >
          @if(saving()) {
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            <span>{{ isEditMode() ? 'Guardando...' : 'Creando...' }}</span>
          } @else {
            <span>{{ submitButtonText() }}</span>
          }
        </button>
      </div>
    </form>
  </div>
</div>