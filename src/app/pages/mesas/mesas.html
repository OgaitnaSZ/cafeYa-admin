<div class="space-y-6">

  <!-- Header con stats -->
  <div class="flex sm:items-center justify-between gap-4">
    <div>
      <h2 class="text-2xl font-black text-gray-900">Gesti贸n de Mesas</h2>
      <p class="text-sm text-gray-500">
        {{ totalMesas() }} mesa{{ totalMesas() !== 1 ? 's' : '' }} registrada{{ totalMesas() !== 1 ? 's' : '' }}
      </p>
    </div>

    <!-- Stats cards -->
    <div class="flex gap-3">
      <div class="px-4 py-2 bg-green-50 border border-green-200 rounded-xl">
        <p class="text-xs text-green-600 font-medium">Disponibles</p>
        <p class="text-xl font-black text-green-700">{{ mesasDisponibles() }}</p>
      </div>
      <div class="px-4 py-2 bg-orange-50 border border-orange-200 rounded-xl">
        <p class="text-xs text-orange-600 font-medium">Ocupadas</p>
        <p class="text-xl font-black text-orange-700">{{ mesasOcupadas() }}</p>
      </div>
    </div>
  </div>

  <!-- Filtros y bot贸n crear -->
  <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100">
    <div class="flex flex-col sm:flex-row justify-between gap-3">
      
      <!-- Filtros de estado -->
      <div class="flex gap-2 flex-wrap">
        <button
          (click)="filtroEstado.set('todas')"
          class="px-4 py-2 rounded-xl text-sm font-semibold transition"
          [class.bg-orange-500]="filtroEstado() === 'todas'"
          [class.text-white]="filtroEstado() === 'todas'"
          [class.shadow-md]="filtroEstado() === 'todas'"
          [class.bg-white]="filtroEstado() !== 'todas'"
          [class.text-gray-600]="filtroEstado() !== 'todas'"
          [class.border]="filtroEstado() !== 'todas'"
          [class.border-gray-200]="filtroEstado() !== 'todas'"
        >
          Todas ({{ totalMesas() }})
        </button>
        <button
          (click)="filtroEstado.set('Disponible')"
          class="px-4 py-2 rounded-xl text-sm font-semibold transition"
          [class.bg-green-500]="filtroEstado() === 'Disponible'"
          [class.text-white]="filtroEstado() === 'Disponible'"
          [class.shadow-md]="filtroEstado() === 'Disponible'"
          [class.bg-white]="filtroEstado() !== 'Disponible'"
          [class.text-gray-600]="filtroEstado() !== 'Disponible'"
          [class.border]="filtroEstado() !== 'Disponible'"
          [class.border-gray-200]="filtroEstado() !== 'Disponible'"
        >
          Disponibles ({{ mesasDisponibles() }})
        </button>
        <button
          (click)="filtroEstado.set('Ocupada')"
          class="px-4 py-2 rounded-xl text-sm font-semibold transition"
          [class.bg-orange-500]="filtroEstado() === 'Ocupada'"
          [class.text-white]="filtroEstado() === 'Ocupada'"
          [class.shadow-md]="filtroEstado() === 'Ocupada'"
          [class.bg-white]="filtroEstado() !== 'Ocupada'"
          [class.text-gray-600]="filtroEstado() !== 'Ocupada'"
          [class.border]="filtroEstado() !== 'Ocupada'"
          [class.border-gray-200]="filtroEstado() !== 'Ocupada'"
        >
          Ocupadas ({{ mesasOcupadas() }})
        </button>
      </div>

      <!-- Bot贸n crear -->
      <button
        (click)="openCreateModal()"
        class="
          h-11 px-5
          bg-linear-to-r from-orange-500 to-red-500
          text-white text-sm font-bold
          rounded-xl
          shadow-lg shadow-orange-500/20
          hover:shadow-xl hover:shadow-orange-500/30
          active:scale-95
          transition-all
          flex items-center gap-2
          whitespace-nowrap cursor-pointer
        "
      >
        <lucide-angular [img]="Plus" class="w-5 h-5"></lucide-angular>
        Nueva Mesa
      </button>
    </div>
  </div>

  <!-- LoadingLista -->
  @if(loadingLista()) {
    <div class="flex justify-center py-12">
      <div class="w-12 h-12 border-4 border-orange-200 border-t-orange-500 rounded-full animate-spin"></div>
    </div>
  }

  <!-- Grid de mesas -->
  @if(!loadingLista() && mesasFiltradas().length > 0) {
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
      @for(mesa of mesasFiltradas(); track mesa.mesa_id) {
        @let estadoStyles = getEstadoStyles(mesa.estado);
        
        <div class="
          bg-white rounded-2xl p-4
          shadow-sm border border-gray-100
          hover:shadow-md hover:border-gray-200
          transition-all duration-200
          group
        ">
          <div class="flex items-start justify-between mb-3">
            <div 
              class="w-14 h-14 rounded-xl flex items-center justify-center text-2xl font-black shadow-md"
              [ngClass]="[estadoStyles.bg, estadoStyles.text]"
            >
              {{ mesa.numero }}
            </div>
            
            <span 
              class="px-2 py-1 rounded-lg text-[10px] font-bold flex items-center gap-1"
              [ngClass]="[estadoStyles.badgeBg, estadoStyles.badgeText]"
            >
              <span class="w-1.5 h-1.5 rounded-full" [ngClass]="estadoStyles.dot"></span>
              {{ estadoStyles.label }}
            </span>
          </div>

          <!-- Info de sesi贸n activa -->
          @if(mesa.estado === 'Ocupada' && mesa.sesion) {
            <div class="mb-3 p-2 bg-orange-50 border border-orange-100 rounded-lg">
              <p class="text-[10px] text-orange-600 font-semibold mb-1">Sesi贸n activa</p>
              @if(mesa.sesion.cliente_nombre) {
                <p class="text-xs font-semibold text-gray-900 truncate">{{ mesa.sesion.cliente_nombre }}</p>
              }
              @if(mesa.sesion.pedidos_count) {
                <p class="text-xs text-gray-600">{{ mesa.sesion.pedidos_count }} pedido{{ mesa.sesion.pedidos_count !== 1 ? 's' : '' }}</p>
              }
            </div>
          }

          <!-- C贸digo de acceso -->
          <div class="mb-3 pb-3 border-b border-gray-100">
            <div class="flex items-center justify-between mb-1">
              <p class="text-[10px] text-gray-500 font-medium">C贸digo de acceso</p>
              <button
                (click)="copiarCodigo(mesa.codigo, $event)"
                class="text-gray-400 hover:text-orange-600 transition cursor-pointer"
                title="Copiar c贸digo"
              >
                <lucide-angular [img]="Copy" class="w-4 h-4"></lucide-angular>
              </button>
            </div>
            <p class="text-lg font-black text-gray-900 tracking-widest">{{ mesa.codigo }}</p>
          </div>

          <!-- Acciones -->
          <div class="space-y-2">
            <!-- Fila 1: Ver QR y Regenerar -->
            <div class="flex gap-2">
              <button
                (click)="verCodigo(mesa, $event)"
                class="
                  flex-1 h-8
                  bg-gray-100 text-gray-700
                  rounded-lg
                  hover:bg-gray-200
                  active:scale-95
                  transition-all
                  flex items-center justify-center gap-1.5
                  text-xs font-semibold cursor-pointer
                "
                title="Ver c贸digo QR"
              >
                <lucide-angular [img]="QrCode" class="w-3.5 h-3.5"></lucide-angular>
                <span>Ver QR</span>
              </button>

              <button
                (click)="regenerarCodigo(mesa, $event)"
                class="
                  w-8 h-8 px-2
                  bg-blue-100 text-blue-600
                  rounded-lg
                  hover:bg-blue-200
                  active:scale-95
                  transition-all
                  flex items-center justify-center cursor-pointer
                "
                title="Regenerar c贸digo"
              >
                <lucide-angular [img]="RefreshCw" class="w-3.5 h-3.5"></lucide-angular>
              </button>
            </div>

            <!-- Fila 2: Editar y Eliminar -->
            <div class="flex gap-2">
              <button
                (click)="openEditModal(mesa)"
                class="
                  flex-1 h-8
                  bg-orange-100 text-orange-600
                  rounded-lg
                  hover:bg-orange-200
                  active:scale-95
                  transition-all
                  flex items-center justify-center gap-1.5
                  text-xs font-semibold cursor-pointer
                "
                title="Editar mesa"
              >
                <lucide-angular [img]="Pen" class="w-3.5 h-3.5"></lucide-angular>
                <span>Editar</span>
              </button>

              <button
                (click)="openDeleteModal(mesa, $event)"
                [disabled]="mesa.estado === 'Ocupada'"
                class="
                  w-8 h-8
                  bg-red-100 text-red-600
                  rounded-lg
                  hover:bg-red-200
                  disabled:opacity-50 disabled:cursor-not-allowed
                  active:scale-95
                  transition-all
                  flex items-center justify-center cursor-pointer
                "
                title="Eliminar mesa"
              >
                <lucide-angular [img]="Trash2" class="w-3.5 h-3.5"></lucide-angular>
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  }

  <!-- Estado vac铆o -->
  @if(!loadingLista() && mesasFiltradas().length === 0) {
    <div class="text-center py-16 bg-white rounded-2xl border-2 border-dashed border-gray-200">
      <div class="text-6xl mb-4"></div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">
        @if(filtroEstado() === 'todas') {
          No hay mesas registradas
        } @else {
          No hay mesas {{ filtroEstado() === 'Disponible' ? 'disponibles' : 'ocupadas' }}
        }
      </h3>
      <p class="text-gray-600 mb-6">
        @if(filtroEstado() === 'todas') {
          Cre谩 tu primera mesa para comenzar a gestionar
        } @else {
          Cambi谩 el filtro o cre谩 una nueva mesa
        }
      </p> 
    </div>
  }

</div>

<!-- Modal Form -->
@if(showFormModal()) {
  <app-mesa-form-modal
    [mesa]="selectedMesa()"
    (close)="closeFormModal()"
    (save)="handleMesaSaved($event)"
  />
}

<!-- Modal Eliminar -->
@if(showDeleteModal() && selectedMesa()) {
  <app-confirm-modal
    title="Eliminar Mesa"
    [message]="'驴Est谩s seguro de eliminar la Mesa ' + selectedMesa()!.numero + '?' + 
               (selectedMesa()!.estado === 'Ocupada' ? '<br/><br/><strong class=\'text-red-600\'>锔 Esta mesa est谩 ocupada actualmente</strong>' : '')"
    confirmText="Eliminar"
    confirmClass="bg-red-500 hover:bg-red-600"
    (confirm)="handleDeleteConfirmed()"
    (cancel)="closeDeleteModal()"
  />
}

<!-- Modal C贸digo QR con angularx-qrcode -->
@if(showCodigoModal() && selectedMesa()) {
  <div
    class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4"
    (click)="closeCodigoModal()"
  >
    <div
      class="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 animate-scale-in"
      (click)="$event.stopPropagation()"
    >
      <div class="text-center">
        <!-- Header -->
        <h3 class="text-xl font-black text-gray-900 mb-1">
          Mesa {{ selectedMesa()!.numero }}
        </h3>
        <p class="text-sm text-gray-500 mb-6">Escane谩 el c贸digo QR</p>

        <!-- QR Code generado con angularx-qrcode -->
        <div class="bg-white p-4 rounded-2xl border-2 border-gray-200 mb-4 inline-block">
          <qrcode
            [qrdata]="selectedMesa()!.qr_url || 'https://tudominio.com/verify/' + selectedMesa()!.mesa_id"
            [width]="200"
            [errorCorrectionLevel]="'M'"
            [colorDark]="'#000000'"
            [colorLight]="'#ffffff'"
          ></qrcode>
        </div>

        <!-- C贸digo de acceso -->
        <div class="
          bg-linear-to-br from-orange-50 to-amber-50
          border-2 border-orange-200
          rounded-2xl p-4 mb-4
        ">
          <p class="text-xs text-orange-600 font-semibold mb-1">C贸digo de acceso</p>
          <p class="text-4xl font-black text-orange-600 tracking-widest">
            {{ selectedMesa()!.codigo }}
          </p>
        </div>

        <!-- Enlace -->
        <div class="mb-4 p-3 bg-gray-50 rounded-xl">
          <p class="text-[10px] text-gray-500 mb-1">Enlace directo</p>
          <div class="flex items-center gap-2">
            <p class="text-xs text-gray-700 font-mono truncate flex-1">
              {{ selectedMesa()!.qr_url || 'https://tudominio.com/verify/' + selectedMesa()!.mesa_id }}
            </p>
            <button
              (click)="copiarEnlace(selectedMesa()!, $event)"
              class="
                w-7 h-7 shrink-0
                bg-white border border-gray-200
                rounded-lg
                hover:bg-gray-100
                active:scale-90
                transition-all
                flex items-center justify-center
              "
              title="Copiar enlace"
            >
              <lucide-angular [img]="ExternalLink" class="w-3.5 h-3.5 text-gray-600"></lucide-angular>
            </button>
          </div>
        </div>

        <!-- Info adicional -->
        <p class="text-xs text-gray-500 mb-4">
          Los clientes pueden escanear el QR o ingresar el c贸digo manualmente
        </p>

        <!-- Botones -->
        <div class="flex gap-2">
          <button
            (click)="regenerarCodigo(selectedMesa()!, $event); closeCodigoModal()"
            class="
              flex-1 h-11
              bg-blue-100 text-blue-600
              font-semibold rounded-xl
              hover:bg-blue-200
              active:scale-95
              transition-all
              flex items-center justify-center gap-2
            "
          >
            <lucide-angular [img]="RefreshCw" class="w-4 h-4"></lucide-angular>
            <span>Regenerar</span>
          </button>
          <button
            (click)="closeCodigoModal()"
            class="
              flex-1 h-11
              bg-gray-100 text-gray-700
              font-semibold rounded-xl
              hover:bg-gray-200
              active:scale-95
              transition-all
            "
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
}